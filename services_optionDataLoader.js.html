<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/optionDataLoader.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/optionDataLoader.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

const _ = require("underscore");
const s = require("underscore.string");
const fs = require("fs");
const path = require("path");

/**
 * Loads the data related to options and option groups defined in the metadata.
 *
 * @module services/optionDataLoader
 */
module.exports = optionDataLoader;

/**
 * Creates the loader using the passed configuration.
 *
 * @alias module:services/optionDataLoader
 * @param {OptionGroup[]} optionGroups  - All option groups
 * @param {string} imageDirectory       - Image directory to find resources for options
 * @param {string} imageExtension       - Image filename extension for option resources
 * @return {{createOptionGroupsMap: createOptionGroupsMap, createOptionsMap: createOptionsMap, createOptionImagesMap: createOptionImagesMap}}
 * @throws {Error} when there is a problem with passed parameters
 */
function optionDataLoader(optionGroups, imageDirectory, imageExtension) {

    if (_.isEmpty(optionGroups)) {
        throw new Error("No option groups provided");
    }

    if (s.isBlank(imageDirectory)) {
        throw new Error("No image directory provided");
    }

    if (!fs.existsSync(imageDirectory)) {
        throw new Error("Given image directory does not exist : " + imageDirectory);
    }

    if (s.isBlank(imageExtension)) {
        throw new Error("No image extension provided");
    }

    // prepend dot if passed extension doesn't start with that
    if (!s.startsWith(imageExtension, ".")) {
        imageExtension = "." + imageExtension;
    }

    return {
        /**
         * Creates a map to access option groups by id.
         *
         * Please note that keys of the returned map are string, not integers.
         *
         * @function
         * @instance
         * @return {Object.&lt;string, OptionGroup>}
         */
        createOptionGroupsMap: createOptionGroupsMap,

        /**
         * Creates a map to access options by id.
         * @function
         * @instance
         * @return {Object.&lt;string, Option>}
         */
        createOptionsMap: createOptionsMap,


        /**
         * Creates a map to access images of the options by id.
         *
         * If option doesn't have any color, then value in the map will be
         * the image. Otherwise, fetched value will be again a map. But this
         * time a map of &lt;color, image>.
         *
         * Please note that reading the images into memory for all
         * options with their colors are quite a big thing. Don't call
         * this method more than once!
         *
         * @function
         * @instance
         * @return {Object.&lt;string, OptionImageMapValueItem>}
         */
        createOptionImagesMap: createOptionImagesMap
    };


    function createOptionGroupsMap() {
        return _.indexBy(optionGroups, "id");
    }

    function createOptionsMap() {
        const optionsMap = {};

        for (let optionGroup of optionGroups) {
            for (let option of optionGroup.options) {
                optionsMap[option.id] = option;
            }
        }

        return optionsMap;
    }

    function createOptionImagesMap() {
        const optionImagesMap = {};

        for (let optionGroup of optionGroups) {
            for (let option of optionGroup.options) {

                if (option.colors) {
                    optionImagesMap[option.id] = {};
                    for (let color of option.colors) {
                        optionImagesMap[option.id][color] = fs.readFileSync(getFilePath(option, color));
                    }
                }
                else {
                    optionImagesMap[option.id] = fs.readFileSync(getFilePath(option, null));
                }
            }
        }

        return optionImagesMap;
    }

    /**
     * Get the file path for the option w/ given optional color.
     *
     * @private
     * @param option
     * @param color
     * @return {string} the file path
     *
     * @example
     * // returns "/some/path/skin.png"
     * getFilePath({resource:"skin"}, color:undefined)
     *
     * @example
     * // returns "/some/path/skin_FF00FF.png"
     * getFilePath({resource:"skin"}, color:"FF00FF")
     *
     */
    function getFilePath(option, color) {
        if (!color) {
            return path.join(imageDirectory, option.resource + imageExtension);
        }
        else {
            return path.join(imageDirectory, option.resource + "_" + colorName(color) + imageExtension);
        }
    }
}

function colorName(color) {
    return color.replace("#", "hash");
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-environment.html">environment</a></li><li><a href="module-middlewares_v1_authenticate.html">middlewares/v1/authenticate</a></li><li><a href="module-routes_v1_api.html">routes/v1/api</a></li><li><a href="module-routes_v1_login.html">routes/v1/login</a></li><li><a href="module-routes_v1_utils.html">routes/v1/utils</a></li><li><a href="module-services_customizationValidator.html">services/customizationValidator</a></li><li><a href="module-services_facebook.html">services/facebook</a></li><li><a href="module-services_optionData.html">services/optionData</a></li><li><a href="module-services_optionDataLoader.html">services/optionDataLoader</a></li><li><a href="module-services_userManager.html">services/userManager</a></li><li><a href="module-test_app-integration-helper-commons.html">test/app-integration-helper-commons</a></li><li><a href="module-test_app-integration-helper-customization.html">test/app-integration-helper-customization</a></li><li><a href="module-test_app-integration-helper-user.html">test/app-integration-helper-user</a></li><li><a href="module-utils_commonUtils.html">utils/commonUtils</a></li><li><a href="module-utils_expressUtils.html">utils/expressUtils</a></li></ul><h3>Classes</h3><ul><li><a href="User.html">User</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Mar 16 2016 17:52:48 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
