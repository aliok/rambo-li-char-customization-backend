<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

const cluster = require("cluster");
const express = require("express");
const bodyParser = require("body-parser");
const morgan = require("morgan");
const cors = require("cors");
const winston = require("winston");
const bluebird = require("bluebird");

/**
 * This is the application module.
 *
 * @module app
 */

/**
 * Starts the application and returns it.
 *
 * Please note that this module is designed to be a singleton. Any subsequent loading
 * (require("app")) will return the already started application if any.
 *
 * If `environment.debug === true` it doesn't create any workers, thus a single process.
 * Otherwise, it creates a worker for each CPU.
 *
 * Dead workers will be replaced with new ones.
 *
 * Please note that `startedCallback` is called for each worker.
 *
 * @alias module:app
 * @param {module:environment} environment  - environment to use
 * @param {Function} startedCallback        - callback to call once application is started. Receives the `app` instance.
 * @return {module:app} the app that is created
 */
module.exports = function startApp(environment, startedCallback) {
// IMPL note: about `startedCallback is called for each worker`:
//            it was very hard to cluster master to get notified.
//            when workers started and then calling this callback.
//            it doesn't make sense sense anyway since workers die
//            and get replaced.


    // this definition must come before require('./routes')
    const app = express();

    // let's export the Express app as the module exports.
    // that might be useful if something here needs to be accessible by another module
    // see http://stackoverflow.com/questions/14822584/express-accessing-app-set-settings-in-routes
    // we override the export so that any subsequent loading of this module
    // returns the same app. this approached is used in so many places.
    module.exports = app;

    // Bring Mongoose into the app.
    // see http://theholmesoffice.com/mongoose-connection-best-practice/
    // Bluebird suggests that it is better to promisify Mongoose
    // than using Mongoose's
    // see http://bluebirdjs.com/docs/working-with-callbacks.html#mongoose
    const mongoose = bluebird.promisifyAll(require("mongoose"));

    /**
     * Promisified Mongoose instance is exported so that we don't need to
     * do it in submodules as well.
     * @member mongoose
     * @instance mongoose
     */
    app.mongoose = mongoose;

    const constants = require("./constants");
    const numCPUs = require("os").cpus().length;

    // clustering
    // we create a worker for each CPU if no debug env
    if (!environment.debug &amp;&amp; cluster.isMaster) {
        // fork based on number of CPUs
        for (let i = 0; i &lt; numCPUs; i++) {
            cluster.fork();
        }

        // Listen for dying workers
        cluster.on("exit", function (worker) {
            winston.info(`worker ${worker.process.pid} died`);
            // Replace the dead worker, we're not sentimental
            cluster.fork();
        });
    }
    else {
        // if we're in a worker: start the application
        // if we're in master but we have env.debug===true: start the application
        startApplication(startedCallback);
    }

    let server;

    /**
     * Stops the application for current worker.
     * @method shutdown
     * @instance shutdown
     * @param {Function} callback - Called when application is shut down.
     */
    app.shutdown = function (callback) {
        winston.info("Shutting down...");
        mongoose.connection.close(function () {
            server.close(function () {
                module.exports = startApp;
                callback();
            });
        });
    };

    return app;

    /////////////////////////////////////////////////////

    function startApplication(startedCallback) {
        // Workers can share any TCP connection
        // In this case it is an HTTP server

        // When successfully connected to DB
        mongoose.connection.on("connected", function () {
            winston.info("Mongoose default connection open to %s", environment.databaseUrl);

            enableCORS();
            addMiddlewares();
            enableRoutes();
            registerErrorHandlers();

            // start server when DB connection is successful
            server = app.listen(constants.listenPort, constants.listenHost, function () {
                const host = server.address().address;
                const port = server.address().port;

                winston.info("App listening at http://%s:%s", host, port);
                if (startedCallback) {
                    startedCallback(app);
                }
            });
        });

        // If the DB connection throws an error
        mongoose.connection.on("error", function (err) {
            winston.error("Mongoose default connection error", err);
        });

        // When the DB connection is disconnected
        mongoose.connection.on("disconnected", function () {
            winston.info("Mongoose default connection disconnected");
        });

        // If the Node process ends, close the Mongoose connection
        //noinspection ES6ModulesDependencies
        process
            .on("SIGINT", gracefulExit)
            .on("SIGTERM", gracefulExit);

        try {
            // register models
            require("./models");
            mongoose.connect(environment.databaseUrl);
            winston.info("Trying to connect to DB : %s", environment.databaseUrl);
        } catch (err) {
            winston.error("Sever initialization failed ", err.message);
        }
    }

    function gracefulExit() {
        mongoose.disconnect(function () {
            winston.info("Mongoose default connection disconnected through app termination");
            //noinspection ES6ModulesDependencies
            process.exit(0);
        });
    }

    function enableCORS() {
        // enable CORS and enable CORS preflight
        app.use(cors());
        app.options("*", cors()); // this must be included before other routes
    }

    function addMiddlewares() {
        app.use(morgan("dev"));
        app.use(bodyParser.json());

        // auth middleware: this will check if the passed access token is valid
        // only the requests that start with /api/v1/auth/* will be checked for the token.
        const authenticateV1 = require("./middlewares/v1/authenticate");
        app.all("/api/v1/auth/*", [authenticateV1]);
    }

    function enableRoutes() {
        // ok, time to enable all routes
        const routes = require("./routes");
        app.use("/", routes);
    }

    function registerErrorHandlers() {
        // register a 404 handler
        app.use(function (req, res) {
            res.status(404).json("Sorry cant find that!");
        });

        // register a 500 handler
        app.use(function (err, req, res) {
            winston.error(err.stack);
            res.status(500).json("Something broke!");
        });
    }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-environment.html">environment</a></li><li><a href="module-middlewares_v1_authenticate.html">middlewares/v1/authenticate</a></li><li><a href="module-routes_v1_api.html">routes/v1/api</a></li><li><a href="module-routes_v1_login.html">routes/v1/login</a></li><li><a href="module-routes_v1_utils.html">routes/v1/utils</a></li><li><a href="module-services_customizationValidator.html">services/customizationValidator</a></li><li><a href="module-services_facebook.html">services/facebook</a></li><li><a href="module-services_optionData.html">services/optionData</a></li><li><a href="module-services_optionDataLoader.html">services/optionDataLoader</a></li><li><a href="module-services_userManager.html">services/userManager</a></li><li><a href="module-test_app-integration-helper-commons.html">test/app-integration-helper-commons</a></li><li><a href="module-test_app-integration-helper-customization.html">test/app-integration-helper-customization</a></li><li><a href="module-test_app-integration-helper-user.html">test/app-integration-helper-user</a></li><li><a href="module-utils_commonUtils.html">utils/commonUtils</a></li><li><a href="module-utils_expressUtils.html">utils/expressUtils</a></li></ul><h3>Classes</h3><ul><li><a href="User.html">User</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Mar 16 2016 17:52:48 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
